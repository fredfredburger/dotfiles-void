#!/bin/sh

# -b (backend) option requires dmenu
# https://tools.suckless.org/dmenu/

# -s (saturation) option requires wjt
# https://github.com/ianremmler/wjt
# or
# https://github.com/tdukv/wjt

wpdir="$HOME/pics/wp/1366x768/"
## wpdir="$HOME/pics/wp/1920x1080/"
## wpdir="$HOME/pics/wp/2560x1440/"

be="schemer2
colorz
wal
haishoku
colorthief"

while getopts 'bsk' c
do
  case $c in
    b)
      p="$(cat "${XDG_CACHE_HOME:-${HOME}/.cache}/wal/wal")"
      b=$(echo "$be" | dmenu)
      beopt="--backend $b"
      ;;
    s)
      p="$(cat "${XDG_CACHE_HOME:-${HOME}/.cache}/wal/wal")"
      # TODO: How to figure which backend was used last time?
      while read -r st; do
        s=$st
      done <<EOT
      $(wjt -p "saturation:" -x 75)
EOT
      # Convert to a decimal point format
      [ -z "$s" ] && break
      if   [ "$s" = 100 ]; then
          stopt="--saturate 1.0"
      elif [ "$s" -lt 10 ]; then
          stopt="--saturate 0.0${s}"
      else
          stopt="--saturate 0.${s}"
      fi
      ;;
    k) bgopts="-b 000000" ;;
    ?) ;;
  esac
done

[ -z "$p" ] && \
  p="$(find "${wpdir}" -maxdepth 1 -type f |
           shuf |
           sxiv -ifot |
           head -1)"

[ -z "$p" ] && notify-send "Nothing selected." && exit 0

# shellcheck disable=SC2086
wal ${bgopts} ${beopt} ${stopt} -qsti "$p"

updatecolors    # update dwm, st

pkill -u "$USER" -x dunst  # update dunst
notify-send -i "$p" "Theme changed." "${stopt#--}\n${beopt#--}\n$(basename "$p")"
